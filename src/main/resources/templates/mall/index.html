<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="mall/header::general-libraries-and-styles(~{::title}, ~{::link}, ~{this::head/script})">
    <meta charset="UTF-8">
    <title>Mall</title>
    <link th:include="mall/header::swiper"/>
    <link rel="stylesheet" href="/styles/mall/all.css"/>
    <link rel="stylesheet" href="/styles/mall/index.css"/>
</head>
<body>
<nav th:replace="mall/navbar::navbar"></nav>
<main>
    <div class="floor">
        <div class="first-screen">
            <div class="category-menu">
                <th:block th:each="l1category : ${categories}">
                    <div class="category-level1" th:data-id="${l1category.getCategoryId()}">
                        <span th:text="${l1category.getCategoryName()}"></span>
                    </div>
                </th:block>
                <div class="category-sub-menu-container">
                    <div class="category-sub-menu">
                        <!-- rendering in javascript -->
                    </div>
                </div>
            </div>
            <div class="swiper">
                <div class="swiper-wrapper">
                    <th:block th:each="carousel : ${carousels}">
                        <div class="swiper-slide">
                            <img th:src="${baseUrl} + ${carousel.getCarouselUrl()}" alt="carousel image">
                        </div>
                    </th:block>
                </div>
                <!-- Pagination -->
                <div class="swiper-pagination"></div>
                <!-- navigation buttons -->
                <div class="swiper-button-prev"></div>
                <div class="swiper-button-next"></div>
                <!-- scrollbar -->
                <div class="swiper-scrollbar"></div>
            </div>
        </div>
    </div>
</main>
<script th:inline="javascript">
    const categories = getCategoriesMap();
    const swiper = new Swiper(".swiper", {
        direction: "horizontal",
        loop: true,
        pagination: {el: ".swiper-pagination"},
        navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
        },
        scrollbar: {el: ".swiper-scrollbar"},
    });

    let mouseInCategoryOption = false;
    let mouseInSubMenu = false;

    $(document).ready(() => {
        bindCategoryOptionsEvent();
        bindSubMenuEvent();
    });

    function bindCategoryOptionsEvent() {
        const options = $(".category-level1");
        options.mouseenter((event) => {
            const id = parseInt($(event.target).attr("data-id"));
            const category = categories.get(id);
            if (category == null)
                return;
            prepareSubMenu(category);
        });

        options.mouseleave(() => {
            mouseInCategoryOption = false;
        });
    }

    function bindSubMenuEvent() {
        const subMenu = $(".category-sub-menu");
        subMenu.mouseenter(() => {
            mouseInSubMenu = true;
        });

        subMenu.mouseleave(() => {
            mouseInSubMenu = false;
        });
    }

    function prepareSubMenu(l1category) {
        const subMenu = $(".category-sub-menu");
        const l2categories = l1category.children === null ? [] : l1category.children;
        subMenu.empty();
        subMenu.attr("parent-id", l1category.categoryId);
        calcSubMenuPosition();
        calcSubMenuSize();
        for (let i = 0; i < l2categories.length; i++) {
            const l2category = l2categories[i];
            const l2DOM = jQuery.parseHTML(
                '<div class="category-level2"><div class="category-level2-name">' + l2category.categoryName + '</div></div>');
            const l3categories = l2category.children === null ? [] : l2category.children;
            for (let j = 0; j < l3categories.length; j++) {
                const l3category = l3categories[j];
                const l3DOM = jQuery.parseHTML('<div class="category-level3">' + l3category.categoryName + '</div>');
                $(l2DOM).append(l3DOM);
            }
            subMenu.append(l2DOM);
        }
    }

    function calcSubMenuSize() {
        const categoryMenu = $(".category-menu");
        const menuHeight = categoryMenu.height();
        $(".category-sub-menu").height(menuHeight - 10); //10 = padding
    }

    function calcSubMenuPosition() {
        const category = $(".category-level1");
        const width = category.outerWidth();
        const {left} = category.position();
        const {top} = $(".swiper").position();
        $(".category-sub-menu-container").css({top: top, left: left + width - 10});
    }

    function getCategoriesMap() {
        const categories = [[${categories}]];
        const result = new Map();
        for (let i = 0; i < categories.length; i++) {
            const category = categories[i];
            result.set(category.categoryId, category);
        }
        return result;
    }

    function toggleSubMenuDisplay() {
        if (!mouseInSubMenu && !mouseInCategoryOption) {
            $(".category-sub-menu").hide();
        }
    }
</script>
</body>
</html>