<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="admin/header::general-libraries-and-styles(~{::title}, ~{::link}, ~{::head/script})">
    <meta charset="UTF-8">
    <title th:text="#{create.product}"></title>
    <script th:replace="admin/header::select2"></script>
    <script th:replace="admin/header::cropper"></script>
    <script th:replace="admin/header::CKEditor"></script>
    <link rel="stylesheet" href="/styles/admin/goods-create.css">
</head>
<body>
<div th:replace="admin/sidebar::sidebar-fragment"></div>
<div class="main">
    <div class="block">
        <div class="block-title" th:text="#{product.info}"></div>
        <div th:replace="admin/goods-form-fragment::goods-form"></div>
        <button class="button button-blue float-end" id="btn-update" th:text="#{save}"></button>
    </div>
</div>

<script>
    $(document).ready(() => {
        $("#btn-update").click(() => saveChanges());

        //on image change
        $("#input-product-img").change(() => {
            const [file] = $("#input-product-img").prop("files");
            if (file != null) {
                if (cropper != null) {
                    cropper.destroy();
                }
                const url = URL.createObjectURL(file);
                const img = new Image();
                img.src = url;
                img.onload = () => {
                    const height = img.height;
                    const width = img.width;
                    if (width >= 150 && height >= 150) {
                        $(".img-product").prop("src", url);
                        prepareCropper(width, height);
                    } else {
                        $(".input-image").val("");
                        Swal.fire({
                            title: "[[#{invalid.product.image.resolution}]]",
                            text: " ",
                            showConfirmButton: true,
                            icon: "error"
                        });
                    }
                };
            }
        });
    });

    function saveChanges() {
        if (validateForm() === false) {
            return;
        }

        $("#btn-update").addSpinner();
        const data = new FormData();
        data.append("goods", JSON.stringify(collectFormData()));
        if (cropper != null) {
            cropper.getCroppedCanvas().toBlob((blob) => {
                data.append("coverImage", blob);
                sendUpdateRequest(data);
            }, "image/jpeg", 0.7);
        } else {
            sendUpdateRequest(data);
        }
    }

    function sendUpdateRequest(formData) {
        $.ajax({
            url: "/admin/goods/update",
            method: "POST",
            data: formData,
            contentType: false,
            processData: false,
            success: (response) => {
                if (response.code === 200) {
                    showChangeSavedSwal();
                } else {
                    Swal.fire({
                        title: response.message,
                        text: " ",
                        showConfirmButton: true,
                        icon: "error",
                        position: "top"
                    });
                }
            },
            error: () => showServerErrorSwal(),
            complete: () => $("#btn-update").removeSpinner(),
        });
    }
</script>
</body>
</html>